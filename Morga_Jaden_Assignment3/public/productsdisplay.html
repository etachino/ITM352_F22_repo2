<!--
Jaden Morga
Dec 12 2022
This code creates the website user interface that will allow customers to show and guide them to enter valid quantities in order for purchase
-->
<!DOCTYPE html>
<html>

<head>
    <!-- author: ww3 schools -->
    <title>The Plant Collective</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="allproducts.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karma">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script type="text/javascript" src="./function.js"></script>
    <script type="text/javascript" src="./products.js"></script>

    <style>
        body,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: "Karma", sans-serif
        }

        .w3-bar-block .w3-bar-item {
            padding: 20px
        }
    </style>
    <script>
        let params = (new URL(document.location)).searchParams;

        /* Code to direct user to the appropriate product page; Retrieved from Assignment 3 Example code*/
        // get the query string
        if (params.has('products_key')) {
            var products_key = params.get('products_key');
        }
        else {
            products_key = "Best Sellers";//auto direct to best sellers page
        }
        var products_data;
        loadJSON('get_products_data', function (response) {
            // Parsing JSON string into object
            products_data = JSON.parse(response);
        })
        var this_product_key = '';
        var shopping_cart;
        var total = 0;

        loadJSON('./get_cart', function (response) {
            // Parsing JSON string into object
            shopping_cart = JSON.parse(response);
            for (pk in shopping_cart) {
                total += shopping_cart[pk].reduce((a, b) => a + b);
            }
        });

        // When the window loads, perform the following function:
        window.onload = function () {
            // If the url has 'inputError', it means that there is a negative, non-integer, or non-number value
            if (params.has('inputError')) {
                // Make an alert with the value of key: inputError, which is "Please correct all errors"
                alert(params.get('inputError'));
                for (let i in products) {
                    // Display the error message in the label
                    document.getElementById(`quantity${i}_label`).innerHTML = params.get(`q_error${i}`);
                    // Display what the user inputted in the value of the input box by getting the value from the URL that matches with key 'quantity${i}'
                    inputForm[`qInput${i}`].value = params.get(`quantity${i}`);
                }
            }
            // If the url has the key 'noQuantities', it means that there are no quantities inputted
            // If so, send an alert with the value 'Please enter a quantity'
            if (params.has('noQuantities')) {
                alert(params.get('noQuantities'));
            }
        }

        //This code displays my website which includes textboxes that customers can fill out. The code below creates which quantitees are valid to go through to the invoice
        // Checking to see if inbox has valid quantities and to add pop ups to inform customers 
        function checkQuantityTextbox(theTextbox) {
            console.log("in checkbox", theTextbox.name);

            // Setting all errors to isNonNegInt
            errors = isNonNegInt(theTextbox.value, true);
            //Will Display if input is 0
            if (errors.length == 0) errors = ['Enter your quantity desired: '];
            //Will display if input is blank
            if (theTextbox.value.trim() == '') errors = ['Enter your quantity desired: '];
            //Will display errors in red font
            if (errors.length > 0) {
                document.getElementById(theTextbox.name + '_label').innerHTML = errors.join(
                    '<font color="red">, </font>');
            }
        }
        //Code Referenced from Lab 11 Ex 5
        function isNonNegInt(arrayElement, returnErrors = false) {
            errors = []; // assume no errors at first
            if (Number(arrayElement) != arrayElement) errors.push(
                '<font color="red">Not a number!</font>'); // Check if string is a number value
            else {
                if (arrayElement < 0) errors.push('<font color="red">Quantity cannot be a negative!</font>');
                // Checking if input is an integer; // Check if it is non-negative
                if (parseInt(arrayElement) != arrayElement) errors.push(
                    '<font color="red">Not an integer!</font>'); // Check that it is an integer
                if ((parseInt(arrayElement) == arrayElement) && (arrayElement >=
                    0)) { // Check that it is a positive integer
                    // Loop through the products array
                    for (let i = 0; i < products.length; i++) {
                        // Set user input ID
                        var inputValue = document.getElementById(`qInput${i}`).value;
                        //IR3 (When user inputs quantity higher than what is available)
                        if ((inputValue > 0) && (inputValue > products[i].quantity_available)) {
                            // Push the error message
                            errors.push(`We do not have ${arrayElement} available.`);
                            // Calculate the difference between the amount inputted and inventory amount
                            var extra = arrayElement - products[i].quantity_available;
                            document.getElementById(`qInput${i}`).value = arrayElement - extra;
                            // Show oupt in red
                            document.getElementById(`quantity${i}_label`).style.color = "red";

                        }
                    }
                }
            }
            return (returnErrors ? errors : (errors.length == 0));
        };
    </script>
</head>

<body>
    <!-- !PAGE CONTENT! -->
    <!-- !IR3 Assignment 3 Search Bar! -->
    <script>
      //Referenced and modified from W3 schools: https://www.w3schools.com/howto/howto_js_filter_lists.asp
        function searchProducts() {
          // Declare variables
          var input, filter, p, i, txtValue;
          input = document.getElementById('product-search');
          //Converts to all uppercase
          filter = input.value.toUpperCase();
          var productsdivs = document.getElementsByClassName("panel-body");

          // Loop through all list items, and hide those who don't match the search query
          for (i = 0; i < productsdivs.length; i++) {
              //Grabs class name of products name 
            p = productsdivs[i].getElementsByClassName("prodname")[0];
            txtValue = p.textContent || p.innerText;
            //Shows all the products that match input
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              productsdivs[i].style.display = "";
            } else {
                //nothing will display if input does not macth products name
              productsdivs[i].style.display = "none";
            }
          }
        }
        </script>
    <div class="w3-main w3-content w3-padding" style="max-width:2000px;margin-top:100px" >
        <!-- !IR3 Assignment 3 Search Bar! -->
       <input type="search" placeholder="Search.." id="product-search" onkeyup="searchProducts()" >
           
        <!-- Top menu -->
        <div class="w3-top">
            <!-- Sidebar (hidden by default) -->
            <nav class="w3-sidebar w3-bar-block w3-card w3-top w3-xlarge w3-animate-left"
                style="display:none;z-index:2;width:40%;min-width:300px" id="mySidebar">
                <a href="javascript:void(0)" onclick="w3_close()" class="w3-bar-item w3-button">Close Menu</a>
                <script>
                    nav_bar(this_product_key, products_data);
                </script>
                <a href="./index.html" onclick="w3_close()" class="w3-bar-item w3-button">Home</a>
                <a href="./login.html" onclick="w3_close()" class="w3-bar-item w3-button">Log In</a>
                <a href="./register.html" onclick="w3_close()" class="w3-bar-item w3-button">Register</a>
                <a href="./cart.html" onclick="w3_close()" class="w3-bar-item w3-button">My Cart</a>
            </nav>
            <div class="w3-white w3-xlarge" style="max-width:1200px;margin:auto">
                <div class="w3-button w3-padding-16 w3-left" onclick="w3_open()">â˜°</div>
                <div class="w3-center w3-padding-16">The Plant Collective &#127793</div>
            </div>
        </div>
        <form action="add_to_cart" method="POST" id="inputForm">
            <main>
                <script>
                    document.write(`<input type = "hidden" name="products_key" value="${products_key}">`);
                    for (i = 0; i < products[products_key].length; i++) { //modifed asst 3 example code

                        document.write(`
                      <div class="panel-body"><img src="${products[products_key][i].image}"</div>
                        <p class="prodname">${products[products_key][i].name}</p>
                        <p><strong>$${products[products_key][i].price.toFixed(2)}</strong></p>
                        <p id="quantity[${i}]_label">Quantity:</p>
                        <input type="text" placeholder="We have ${products[products_key][i].quantity_available} available" name="quantity${i}" id="quantity[${i}]" onkeyup="checkQuantityTextbox(this);">
                        <input type="submit" class="button" value="Add to Cart" id="submit">
                    </div>
        `);
                    }
                </script>
            </main>

            <script>
                // Make a hidden input box to store the products_key so it can be used on server side
                document.write(`<input type='hidden' name='products_key' value='${products_key}'`);
                // Script to open and close sidebar
                function w3_open() {
                    document.getElementById("mySidebar").style.display = "block";
                }

                function w3_close() {
                    document.getElementById("mySidebar").style.display = "none";
                }
            </script>
        </form>

</body>

</html>