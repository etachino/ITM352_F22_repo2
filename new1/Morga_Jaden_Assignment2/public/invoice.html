<!--
Jaden Morga
Oct 17 2022
This code creates the invoice side of my website that outputs the correct total after taking into account shipping and taxes
-->
<script src="./products.js" type="text/javascript"></script>
<script>
  //Message will appear when page laods to alert user that they have successfully logged in
  alert("Successful Login!")
  // Product Quantities are in the querystring
  //Get request for products in array
  let params = (new URL(document.location)).searchParams;
  //New array with quantities the user inputs
  var quantities = [];
  // Invoice generation based on product quantities in querystring.
  if (params.has('purchasebutton')) {
    for (i = 0; i < products.length; i++) {
      if (params.has(`quantity${i}`)) {
        a_qty = params.get(`quantity${i}`);
        quantities[i] = a_qty;
      }
    }
  }
</script>
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="invoice.css">
  <title>Invoice</title>
  <h1>Your Purchases&#127793</h1>
  <!--
Displaying IR5 by grabbing div ids
-->
  <h1 id="IR5"></h1>
  <h1 id="currentUsers"></h1>

</head>

<body>
  <script>

    //invoice table template from Store 1 WOD
    document.write(`
   <table border="2">
   <tbody>
  <tr>
    <th style="text-align: center;" width="43%">Item</th>
    <th style="text-align: center;" width="11%">quantity</th>
    <th style="text-align: center;" width="13%">price</th>
    <th style="text-align: center;" width="54%">extended price</th>
  </tr>
  `)

    // Modified from Store 1 WOD
    sub_total = 0;
    for (i = 0; i < products.length; i++) {
      if (quantities[i] > 0) {
        //Product Row
        extended_price = quantities[i] * products[i].price;
        sub_total += extended_price;
      }
    }

    //Referenced from Invoice 3 WOD
    function isNonNegInt(quantity) {

      errors = []; // assume no errors at first
      if (quantity == "") quantity == 0; //If no input is inputted it will be assigned as 0
      if (Number(quantity) != quantity) {
        errors.push('Not a number!'); // Check if string is a number value

      }
      else {
        if (quantity < 0) {
          errors.push('Negative value!'); // Check if it is non-negative

        }
        if (parseInt(quantity) != quantity) {
          errors.push('Not an integer!'); // Check that it is an integer

        }

      }
      return errors.length == 0;
    }
    function generate_item_rows() {
      //Taken from Store 1 WOD

      for (i in products) {
        let qty = params.get('quantity' + i);
        if (qty == 0) {
          continue;
        }
        let extended_price = 0;
        if (isNonNegInt(qty) == true) {
          extended_price = Number(qty) * products[i]['price'];
          sub_total = sub_total + extended_price;
        }
        console.log(qty, products[i]['price'], extended_price);
        document.write(`
  <tr>
    <td> <img src="${products[i].image}" style="width:30%">${products[i]['name']}</td>
  <td align="center" width="11%" style="color:red">${qty}<br>${errors.join('<br>')}</td>
  <td width="13%">$${products[i]['price']}</td>
  <td width="54%">$${extended_price}</td>
  </tr>
`)

        // Referenced & Modified from Invoice 3 WOD
      }
    }
    generate_item_rows();

    //compute tax
    var tax_rate = .020;
    var tax = sub_total * tax_rate;

    // Compute shipping based on shipping policy
    var shipping
    if (sub_total <= 49.99) {
      shipping = 10;
    } else if (50 < sub_total <= 99.99) {
      shipping = 5;
    } if (sub_total > 100) {
      shipping = 0
    }

    //compute total 
    var total = tax + sub_total + shipping;

    //Displays subtotal,tax rate, shipping, and total price correctly at the bottom of the invoice
  </script>

  <tr>
    <td colspan="4" width="100%">&nbsp;</td>
  </tr>
  <tr>
    <td style="text-align: center;" colspan="3" width="67%">Sub_total</td>
    <td width="54%">$
      <script>
        document.write(sub_total);
      </script>
  <tr>
    <td style="text-align: center;" colspan="3" width="67%"><span style="font-family: arial;">Tax @
        <script>
          document.write(tax_rate * 100); </script>%
      </span></td>
    <td width="54%">$
      <script>
        document.write(tax.toFixed(2));
      </script>
    </td>

  <tr>

  <tr>
    <td style="text-align: center;" colspan="3" width="67%"><span style="font-family: arial;">Shipping
      </span></td>
    <td width="54%">$
      <script>
        document.write(shipping.toFixed(2));
      </script>
    </td>

  <tr>
    <td style="text-align: center;" colspan="3" width="67%"><strong>Total</strong></td>
    <td width="54%">$<stong>
        <script>
          document.write(total.toFixed(2));
        </script>
      </stong>
</body>
</table>

<script>
  //Part of IR5
  // Get url
  window.onload = function () {
    //Creating ID 
    document.getElementById('IR5').innerHTML = `Thank you, ${params.get('name')} for shopping with Plant Collective`;
    document.getElementById('currentUsers').innerHTML = `There are currently ${params.get('users')} on our site`;

    // This is to get the values from the url and put it in the hidden input boxes
    invoiceForm['users'].value = params.get('users');
    invoiceForm['email'].value = params.get('email');
    invoiceForm['fullname'].value = params.get('name');
  }

</script>
<form method="POST" name="invoiceForm">
  <input type="hidden" name="users" id="users">
  <input type="hidden" name="fullname" id="fullname">
  <input type="hidden" name="email" id="email">
 <!--
Logout button brings user to back to shop and removes their email from active users
-->
  <input type="submit" class="button" value="Logout" onclick="invoiceForm.action='/process_logout'">
  <div class="shipping">
    <h3>SHIPPING RATES:</h3>
    <p>Under US $49.99: $10</p>
    <p>Between US $50-$99.99: $5</p>
    <p>US $100 or more: <b>Free</b> shipping</p>
  </div></b>

</html>