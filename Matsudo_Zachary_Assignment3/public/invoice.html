<!-- Zachary Matsudo Assignment 3 --> 
<!-- Invoice page to show reciept of purchase with all costs -->
<!DOCTYPE html>
<html>
<script src="./products.js" type="text/javascript"></script>
<script src="/user_data.json" type="json"></script>
<script src="./functions.js"></script>
<script>
  loadJSON('./cart', function (response) {
    // Parse JSON string into an object
    shop_cart = JSON.parse(response);
  });

  // Read the values of a specific cookie
  // Referenced form Lab 15 and W3 schools https://www.w3schools.com/js/js_cookies.asp
  function getCookie(cookie_name) {
    let name = cookie_name + "=";
    let decodedCookie = decodeURIComponent(document.cookie);
    let split_cookie = decodedCookie.split(';');
    for (let i = 0; i < split_cookie.length; i++) {
      let cookie = split_cookie[i];
      while (cookie.charAt(0) == ' ') {
        cookie = cookie.substring(1);
      }
      if (cookie.indexOf(name) == 0) {
        return cookie.substring(name.length, cookie.length);
      }
    }
    return "";
  }

  // Gets the data from the querystring
  let params = (new URL(document.location)).searchParams;
  // Get quantities to store
  var quantities = []; 
  if (params.has('quantity')) {
    // Parameter gets quantity and parses the string into an onject
    quantities = JSON.parse(params.get(`quantity`)); 
  }
  
  // Security to see if user is logged in with cookies
  // If not logged in then user is sent to login page
  if (getCookie('user_cookie') != '') {
    var user_cookie = getCookie('user_cookie');
    var name = user_cookie;
  } else {
    location.href = './login.html';
    window.stop;
  }
</script>

<head>
  <meta charset="UTF-8">
  <!-- Template taken from W3 schools https://www.w3schools.com/w3css/tryit.asp?filename=tryw3css_templates_food_blog&stacked=h-->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karma">
  <!-- My own css that I created to adjsut other elements-->
  <link href="./css/invoice.css" rel="stylesheet">
  <title>Receipt</title>
</head>

<body>
  <script> 
  // Display the users name in the thank you message for purchase.
    if (name != 'undefined' && name != '') {
      document.write(`<div class="thank"><h4><b>Mahalo, ${name}! Here is your invoice:</b><h4></div>`)
    }
  </script>
<table>
  <tbody>
  <thead>
  <tbody>
    <tr>
       <th style="width:10%">Item</th>
       <th class="text-right" style="width:15%">Quantity</th>
       <th class="text-right" style="width:15%">Price</th>
       <th class="text-right" style="width:15%">Extended Price</th>
    </tr>
  </thead>
  <script>
    
  // Compute sub-total
  var subtotal = 0;

  // Shows what items are in the cart
  for (let prod_key in shop_cart) { 
    for (let i in shop_cart[prod_key]) {
      let quantities = shop_cart[prod_key][i];
      if (quantities > 0) {
        // Computes extended price and sub total if there is items in the cart
        extended_price = quantities * products[prod_key][i].price
        subtotal += extended_price;
        document.write(`
          <tr>
		        <td>${products[prod_key][i].brand}</td>
		        <td class="text-right">${quantities}</td>
		        <td class="text-right">$${products[prod_key][i].price.toFixed(2)}</td>
		        <td class="text-right">$${extended_price.toFixed(2)}</td>
          </tr>
       `);
      }
    }
  };

  // Compute tax. Hawaii state tax rate is 4% so I used that number
   var tax_rate = 0.04;
  var tax = tax_rate * subtotal;

  // Compute Shipping. Referenced from invoice 2 WOD.
  // Orders less than $20 will have free shipping, between $21-$40 is $2.50 shipping and orders over $40 is $5 shipping
  if (subtotal <= 20) {
    shipping = 0;
  }
  else if (subtotal <= 40) {
    shipping = 2.50;
  }
  else {
    shipping = 5;
  }

  // Compute grand total
  // Taken from invoice 2 WOD
  var total = subtotal + tax + shipping;

  </script>
</tbody>
</table>
<h2>
  Payment Summary
</h2>
<table class="table2">
  <!-- Referenced from Store 1 WOD and is used to display the sub-total, tax, shipping costs and total. 
sub-total, tax, shipping and total are called using document.write and toFixed used to have it display 2 decimal places-->
  <tr>
    <td style="text-align: center;" width="50%">Sub-total</td>
    <td>$
      <script>document.write(subtotal);</script>
    </td>
  </tr>
  <tr>
    <td style="text-align: center;" width="50%">Tax @ 
      <script>document.write(100 * tax_rate);</script>%
    </td>
    <td>$
      <script>document.write(tax.toFixed(2));</script>
    </td>
  </tr>
  <tr>
    <td style="text-align: center;" width="50%">Shipping</td>
    <td>$
      <script>document.write(shipping.toFixed(2));</script>
    </td>
  </tr>
  <tr>
    <td style="text-align: center;" width="50%"><strong>Total</strong></td>
    <td><strong>$
        <script>document.write(total.toFixed(2));</script>
      </strong></td>
  </tr>
  </tbody>
</table>
<br>
    <!-- Sends an email with invoice -->
    <form action="/mail_invoice" method=POST>
    <center> <input type=submit class="button" id="checkout" value="Email Receipt"> </center>
    </form>
</body>
</html>