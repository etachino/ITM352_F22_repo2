<!-- Zachary Matsudo Assignment 3 --> 
<!-- Products Page where users can browse items and select which items and the quantity they want.
     Selected items and quantity will be added to cart. Users can also favorite items on this page. -->
<!DOCTYPE html>
<html>
<script src="./products.js" type="text/javascript"></script>
<script>
  /* Function referenced from Lab 8. Also referenced Professor Kazmans and Ports Lab 12 repos for different formatting of the function.
  Function checks if input is positive whole number. Negative values, decimals, letters and other characters will outputan error message */
  function isNonNegativeInteger(q, return_errors = false) {
    errors = []; // Assumes there are not errors to start
    if (q == '') q = 0; // If no value is entered into a box it will be set to 0
    if (Number(q) != q) errors.push('<font color="red">Not a number!</font>'); // Check if string is a number value
    else if (q < 0) errors.push('<font color="red">Negative value!</font>'); // Check if it is non-negative
    else if (parseInt(q) != q) errors.push('<font color="red">Not an integer!</font>'); // Check that it is an integer
    return return_errors ? errors : (errors.length == 0);
  }
  
  /* Taken from Lab 12 forms lab. Referenced from Professor Kazman and Ports Lab 12 repos.
     Function used to check values entered into textbox.
     If no errors in textbox, label will display "Selected Items".
     If errors occur, label ending with id "_label" will show error message from isNonNegativeInteger function.
     IR 2 from Assignment 1 */
  function checkQuantityTextbox(getTextbox) {
    quantity_errors = isNonNegativeInteger(getTextbox.value, true);
    if (quantity_errors.length == 0) quantity_errors = ['Selected Items:'];
    document.getElementById(getTextbox.name + '_label').innerHTML = quantity_errors.join(", ");
  }

  // Referenced from Professor Kazmans Lab 13 repo, order_page_new.html
  // Gets query string and alerts users when error is found and what the error is
  let params = (new URL(document.location)).searchParams; 
  window.onload = function () {
    // Check for valid quantities and send to invoice
    if (params.has('errors')) {
      // Turn the string into an object
      var errors = JSON.parse(params.get('errors'));
      let err_str = '';
      // Combine error messages into one string
      for (err in errors) { 
      // \n referenced from W3 schools https://www.w3schools.com/jsref/jsref_regexp_newline.asp#:~:text=The%20%5Cn%20character%20matches%20newline%20characters.
        err_str += errors[err] + '\n';
      }
      // Alerts errors in one string
      alert(err_str);
    }
  
    // Referenced from Stackoverflow https://stackoverflow.com/questions/10033215/how-do-i-add-an-add-to-favorites-button-or-link-on-my-website and https://stackoverflow.com/questions/66762798/how-do-i-add-a-favorite-option-on-my-site
    // Also referenced Lab 15 and watched video https://www.hackingwithswift.com/books/ios-swiftui/letting-the-user-mark-favorites
    // Referenced A3 code examples
    // INDIVIDUAL REQUIREMENT 4
    loadJSON('./get_fav', function (response) {
      // Parse JSON string into an object
      favorites = JSON.parse(response);
      if (typeof favorites[products_key] != 'undefined') {
        for (let i in favorites[products_key]) {
          document.getElementById(`fav${i}`).checked = favorites[products_key][i];
        }
      }
    });
    // Makes cart quantity sticky
    // Referenced from Professor Kazman Lab 13 repo
    if (typeof shop_cart[products_key] != 'undefined') { 
        for (let i in shop_cart[products_key]) {
            document.getElementById(`quantity[${i}]`).value = shop_cart[products_key][i];
        }
      }
    }

  // INDIVIDUAL REQUIREMENT 4
  // Referenced from Stackoverflow https://stackoverflow.com/questions/10033215/how-do-i-add-an-add-to-favorites-button-or-link-on-my-website and https://stackoverflow.com/questions/66762798/how-do-i-add-a-favorite-option-on-my-site
  // Also referenced Lab 15 and watched video https://www.hackingwithswift.com/books/ios-swiftui/letting-the-user-mark-favorites and https://www.youtube.com/watch?v=QQ8UZb1Mv_0 
  // Send query string with favorites to the server
  function user_favorite(prod_key, pindex, fav) {
    console.log(prod_key, pindex, fav.checked);
    loadJSON(`./new_fav?prod_key=${prod_key}&pindex=${pindex}&favorite=${fav.checked}`, function (response) {
    });
  }
</script>

<head>
  <script src="./functions.js"></script>
  <script>
    var shop_cart;
    var total = 0;
    // Get query string
    // Referenced from A3 code examples on class website
    if (params.has('products_key')) { 
      var products_key = params.get('products_key');
    } else {
    // Redirect to hard candy page
      products_key = "hard" 
    }
    
    // Referenced from A3 code examples on class website
    var products;
    loadJSON('./product_data', function (response) {
      // Parse JSON into an object
      products = JSON.parse(response);
    });
    loadJSON('./cart', function (response) {
      // Parse JSON into an object
      shop_cart = JSON.parse(response);
      for (pk in shop_cart) {
        total += shop_cart[pk].reduce((a, b) => a + b);
      }
    });

    // Read the values of a specific cookie
    // Referenced form Lab 15 and W3 schools https://www.w3schools.com/js/js_cookies.asp
    function getCookie(cookie_name) { 
      let name = cookie_name + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let split_cookie = decodedCookie.split(';');
      for (let i = 0; i < split_cookie.length; i++) {
        let cookie = split_cookie[i];
        while (cookie.charAt(0) == ' ') {
          cookie = cookie.substring(1);
        }
        if (cookie.indexOf(name) == 0) {
          return cookie.substring(name.length, cookie.length);
        }
      }
      return "";
    }

</script>

  <meta charset="UTF-8">
  <!-- Template taken from W3 schools https://www.w3schools.com/w3css/tryit.asp?filename=tryw3css_templates_food_blog&stacked=h-->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karma">
  <!-- My own css that I created to adjsut other elements-->
  <link href="./css/products.css" rel="stylesheet">
  <title>Zach's Candy Store</title>
</head>

<body>
<!-- Navigation bar -->
<!-- Style referenced from W3 schools https://www.w3schools.com/w3css/w3css_navigation.asp-->
<nav>
  <div class="w3-bar w3-black">
    <a class="w3-bar-item w3-button w3-mobile" href="index.html">Zach's Candy Store </a>
    <a class="w3-bar-item w3-button w3-mobile" href="./products_page.html?products_key=hard"> Hard </a>
    <a class="w3-bar-item w3-button w3-mobile" href="./products_page.html?products_key=soft"> Soft </a>
    <a class="w3-bar-item w3-button w3-mobile" href="./products_page.html?products_key=chocolate"> Chocolate</a>
    <script>
      // If statement to display account if not logged in or logout if user is logged in
      // Referenced from W3 Schools https://www.w3schools.com/js/js_cookies.asp 
      if (getCookie('user_cookie') != false) {
        var user_cookie = getCookie('user_cookie');
        document.write(`<a href="/logout" class="w3-bar-item w3-button w3-mobile" id="login">Logout</a>`);
        login.onclick = function () {
          document.cookie = "user_cookie=; expires=Tue, 5 Feb 2019 00:00:00 UTC; path=/;";
        }
      } else {
        document.write(`<a href="login.html" class="w3-bar-item w3-button w3-mobile" id="login">Account</a>`);
      }
    </script>
    <a class="w3-bar-item w3-button w3-mobile" href="cart.html"> Cart (<span id="cart_total">0</span>)</a>
    <script>  cart_total.innerHTML = total; </script> 
  </div>  
</nav>
<header>
  <h1>
    Zach's Candy Store
  </h1>
  <br> <br>
  <!-- Displays welcome message after user logs in -->
  <center>
    <script>if(getCookie('user_cookie') != false) {
      document.write(`<h4><b>Welcome, ${user_cookie}!  <br> You are currently logged in</b><h4>`)
      };</script>
    </center>
</header>
<!-- Referenced from W3 schools template https://www.w3schools.com/w3css/tryit.asp?filename=tryw3css_templates_food_blog&stacked=h-->
<div>
  <form name="quantity_form" action="./in_cart" method="POST">
  <main>
    <script>  cart_total.innerHTML = total; </script>
    <script>
      // No favorites at first
      var favorite = {}; 
      document.write(`<input type = "hidden" name="products_key" value="${products_key}">`); 
      // For loop referenced from Store 1 WOD and used to display the products on webpage
      // Brand, image, price, quantity available displayed as well as an option to favorite an item
      // CheckQuantityTextbox function used to validate quantities that were entered into the textboxes
      // INDIVIDUAL REQUIREMENT 4 in here
      // Referenced from A3 code examples on class website and Lab 15
      // IR4 referenced from Stackoverflow https://stackoverflow.com/questions/10033215/how-do-i-add-an-add-to-favorites-button-or-link-on-my-website and https://stackoverflow.com/questions/66762798/how-do-i-add-a-favorite-option-on-my-site
      for (i = 0; i < products[products_key].length; i++) { 
        document.write(`
      <section class="item">  
        <h2>${products[products_key][i].brand}<h2>
        <img src="${products[products_key][i].image}">
        <p>$${products[products_key][i].price}</p>
        <center> <label id="quantity${i}_label_stock"> In Stock: ${products[products_key][i].quantity_available} </label> <center>
        <label id="quantity[${i}]_label"></label>
        <center> <input type="text" name="quantity[${i}]" id="quantity[${i}]" onkeyup="checkQuantityTextbox(this);"> </center>
        <center> Favorite <input type="checkbox" name="fav[${i}]" id="fav${i}" onclick="user_favorite('${products_key}','${i}', this)"> </center>
      </section>
      `);
      };
    </script>
      <input type="submit" class="button" value="Add to Cart">
    </form>
</main>
</div>
</body>
</html>
